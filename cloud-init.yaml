#cloud-config
# ========================================================================
# Cloud-init para despliegue automatizado de AI Platform en PowerVS
# - Instala paquetes base
# - Descarga setup.sh y .env.example desde GitHub
# - Detecta IP externa y configura VITE_API_HOST autom√°ticamente
# - Ejecuta setup.sh para despliegue completo de Docker Compose
# ========================================================================

package_update: true
package_upgrade: true

packages:
  - vim
  - curl
  - git
  - wget
  - htop

# Variables pasadas desde Terraform (NO editar manualmente)
# ${repo_back_url}
# ${repo_front_url}
# ${huggingface_token}
# ${db_password}

runcmd:
  - |
      set -e
      
      echo "=========================================="
      echo "üöÄ INICIANDO DESPLIEGUE AUTOMATIZADO"
      echo "=========================================="
      
      cd /root
      
      # ===== 1. Detectar IP externa =====
      echo "üîç Detectando IP externa..."
      EXTERNAL_IP=$(curl -s https://api.ipify.org)
      
      if [ -z "$EXTERNAL_IP" ]; then
        echo "‚ùå ERROR: No se pudo obtener la IP externa"
        exit 1
      fi
      
      echo "‚úÖ IP externa detectada: $EXTERNAL_IP"
      
      # ===== 2. Descargar setup.sh desde GitHub =====
      echo "üì• Descargando setup.sh desde GitHub..."
      curl -fsSL https://raw.githubusercontent.com/Junstant/IBM-AI-Platform-Back/main/setup.sh -o /root/setup.sh
      
      if [ ! -f "/root/setup.sh" ]; then
        echo "‚ùå ERROR: No se pudo descargar setup.sh"
        exit 1
      fi
      
      chmod +x /root/setup.sh
      echo "‚úÖ setup.sh descargado y ejecutable"
      
      # ===== 3. Descargar .env.example y configurar .env =====
      echo "üì• Descargando .env.example desde GitHub..."
      curl -fsSL https://raw.githubusercontent.com/Junstant/IBM-AI-Platform-Back/main/.env.example -o /root/.env
      
      if [ ! -f "/root/.env" ]; then
        echo "‚ùå ERROR: No se pudo descargar .env.example"
        exit 1
      fi
      
      echo "‚úÖ .env.example descargado"
      
      # ===== 4. Configurar variables en .env =====
      echo "‚öôÔ∏è  Configurando variables en .env..."
      
      # Reemplazar IP externa
      sed -i "s|VITE_API_HOST=\"{EXTERNAL_SERVER_IP}\"|VITE_API_HOST=\"$EXTERNAL_IP\"|g" /root/.env
      
      # Configurar token de HuggingFace (pasado desde Terraform)
      sed -i "s|TOKEN_HUGGHINGFACE=.*|TOKEN_HUGGHINGFACE=${huggingface_token}|g" /root/.env
      
      # Configurar password de DB (pasado desde Terraform)
      sed -i "s|DB_PASSWORD=.*|DB_PASSWORD=${db_password}|g" /root/.env
      
      # Configurar URLs de repositorios (pasado desde Terraform)
      sed -i "s|REPO_BACK_URL=.*|REPO_BACK_URL=\"${repo_back_url}\"|g" /root/.env
      sed -i "s|REPO_FRONT_URL=.*|REPO_FRONT_URL=\"${repo_front_url}\"|g" /root/.env
      
      echo "‚úÖ Variables configuradas en .env:"
      echo "   - VITE_API_HOST: $EXTERNAL_IP"
      echo "   - TOKEN_HUGGHINGFACE: [CONFIGURADO]"
      echo "   - DB_PASSWORD: [CONFIGURADO]"
      echo "   - REPO_BACK_URL: ${repo_back_url}"
      echo "   - REPO_FRONT_URL: ${repo_front_url}"
      
      # ===== 5. Ejecutar setup.sh =====
      echo "=========================================="
      echo "üéØ EJECUTANDO SETUP.SH"
      echo "=========================================="
      
      /root/setup.sh
      
      EXIT_CODE=$?
      
      if [ $EXIT_CODE -eq 0 ]; then
        echo "=========================================="
        echo "‚úÖ DESPLIEGUE COMPLETADO EXITOSAMENTE"
        echo "=========================================="
        echo ""
        echo "üåê Frontend disponible en: http://$EXTERNAL_IP:2012"
        echo "üîå APIs disponibles en puertos: 8000-8004, 8085-8090"
        echo "üóÑÔ∏è  PostgreSQL disponible en puerto: 8070"
        echo ""
        echo "üìä Para ver logs: docker logs [container-name]"
        echo "üìã Para ver servicios: docker ps"
      else
        echo "=========================================="
        echo "‚ùå ERROR EN EL DESPLIEGUE"
        echo "=========================================="
        echo "C√≥digo de salida: $EXIT_CODE"
        echo "Revise los logs en: /var/log/cloud-init-output.log"
        exit $EXIT_CODE
      fi

final_message: |
  ========================================
  üéâ CLOUD-INIT COMPLETADO
  ========================================
  
  El despliegue automatizado ha finalizado.
  Revise los logs en /var/log/cloud-init-output.log
  para detalles completos del proceso.
  
  Si el despliegue fue exitoso, el frontend
  estar√° disponible en el puerto 2012.
  ========================================
